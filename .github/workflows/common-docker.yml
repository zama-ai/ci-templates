name: Docker Build and Push with Multiarch Manifest

on:
  workflow_call:
    secrets:
      BLOCKCHAIN_ACTIONS_TOKEN:
        required: true
      AWS_ACCESS_KEY_S3_USER:
        required: true
      AWS_SECRET_KEY_S3_USER:
        required: true
    inputs:
      ref:
        type: string
        required: false
        default: ''
      working-directory:
        type: string
        required: true
      docker-context:
        type: string
        required: false
        default: '.'
      image-name:
        type: string
        required: true
      push_image:
        type: boolean
        default: true
        required: false
      runs-on-amd:
        type: string
        required: false
        default: 'ubuntu-latest'
      runs-on-arm:
        type: string
        required: false
        default: 'large_ubuntu_16_arm'
      docker-file:
        type: string
        default: 'Dockerfile'
        required: false
      cache-from:
        type: string
        required: false
        default: 'type=gha'
      cache-to:
        type: string
        required: false
        default: 'type=gha,mode=max'
      app-cache-dir:
        type: string
        required: true
    outputs:
      image_name:
        description: "Image Name with Tag generated by this task"
        value: "${{ jobs.create-manifest.outputs.image_name }}"
      image_tag:
        description: "Docker Tag generated by this task"
        value: "${{ jobs.determine-tag.outputs.docker_tag }}"
      image_prod_with_tag:
        description: "Image Name with Tag for production"
        value: ${{ jobs.create-manifest.outputs.image_prod_with_tag }}
      image_dev_with_tag:
        description: "Image Name with Tag for development"
        value: ${{ jobs.create-manifest.outputs.image_dev_with_tag }}
      image_prod_latest:
        description: "Image Name with Tag for production latest"
        value: ${{ jobs.create-manifest.outputs.image_prod_latest }}
      image_dev_latest:
        description: "Image Name with Tag for development latest"
        value: ${{ jobs.create-manifest.outputs.image_dev_latest }}

env:
  RUST_IMAGE_VERSION: '1.86.0'

jobs:
  determine-tag:
    runs-on: ubuntu-latest
    outputs:
      docker_tag: ${{ steps.set-tag.outputs.tag }}
    steps:
      - name: Checkout Project
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set Docker Tag
        id: set-tag
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "tag=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "tag=nightly-$(git rev-parse --short "$GITHUB_SHA")" >> "$GITHUB_OUTPUT"
          else
            echo "tag=$(git rev-parse --short "$GITHUB_SHA")" >> "$GITHUB_OUTPUT"
          fi

  build-and-push-docker:
    needs: determine-tag
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            runs-on: ${{ inputs.runs-on-amd }}
            platform-tag: amd64
            docker-target: prod
          - platform: linux/arm64
            runs-on: ${{ inputs.runs-on-arm }}
            platform-tag: arm64
            docker-target: prod
          - platform: linux/amd64
            runs-on: ${{ inputs.runs-on-amd }}
            platform-tag: amd64
            docker-target: dev
          - platform: linux/arm64
            runs-on: ${{ inputs.runs-on-arm }}
            platform-tag: arm64
            docker-target: dev
    runs-on: ${{ matrix.runs-on }}
    steps:
      - name: Checkout Project
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          submodules: 'true'
          token: ${{ secrets.BLOCKCHAIN_ACTIONS_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb # v3.3.0
        with:
          platforms: ${{ matrix.platform }}


      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4.0.2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_S3_USER }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY_S3_USER }}
          aws-region: eu-west-3



      ############################################################################
      # Setup cache for dockerfile and inject in docker
      #
      - name: Setup Cache
        uses: runs-on/cache@197b09d6da1bf42f673fee18769c794b789a0c7d # v4
        id: cache
        env:
          RUNS_ON_S3_BUCKET_CACHE: gh-actions-cache-eu-west-3
          RUNS_ON_AWS_REGION: eu-west-3
        with:
          path: |
            var-cache-apk
            var-lib-apk
            usr-local-cargo-registry
            usr-local-cargo-git
            usr-local-cargo-bin
            usr-local-cargo-registry-index
            usr-local-cargo-registry-cache
            usr-local-cargo-git-db
            app-${{ inputs.app-cache-dir }}-target
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
            /sccache
          key: |
            ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: inject cache into docker
        uses: reproducible-containers/buildkit-cache-dance@5b6db76d1da5c8b307d5d2e0706d266521b710de # v3.1.2
        with:
          cache-map: |
            {
              "var-cache-apk": "/var/cache/apk",
              "var-lib-apk": "/var/lib/apk",
              "usr-local-cargo-registry": "/usr/local/cargo/registry",
              "usr-local-cargo-git": "/usr/local/cargo/git",
              "usr-local-cargo-bin": "/usr/local/cargo/bin",
              "usr-local-cargo-registry-index": "/usr/local/cargo/registry/index",
              "usr-local-cargo-registry-cache": "/usr/local/cargo/registry/cache",
              "usr-local-cargo-git-db": "/usr/local/cargo/git/db",
              "app-${{ inputs.app-cache-dir }}-target": "/app/${{ inputs.app-cache-dir }}/target",
              "sccache": "/sccache"
            }
          skip-extraction: ${{ steps.cache.outputs.cache-hit }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@902fa8ec7d6ecbf8d84d538b9b233a880e428804  # v5.7.0
        with:
          labels: |
            org.opencontainers.image.title=${{ inputs.image-name }}
            org.opencontainers.image.description=${{ inputs.image-name }} docker image in version ${{ needs.determine-tag.outputs.docker_tag }}
            org.opencontainers.image.vendor=zama.ai
            org.opencontainers.image.version=${{ needs.determine-tag.outputs.docker_tag }}
            org.opencontainers.image.rust-version=${{ env.RUST_IMAGE_VERSION }}

      - name: Docker Build and Push with Platform Tag
        id: push
        uses: docker/build-push-action@5cd11c3a4ced054e52742c5fd54dca954e0edd85 # v6.7.0
        env:
          RUNS_ON_S3_BUCKET_CACHE: gh-actions-cache-eu-west-3
          RUNS_ON_AWS_REGION: eu-west-3
        with:
          build-args: |
            RUST_IMAGE_VERSION=${{ env.RUST_IMAGE_VERSION }}
            TARGETARCH=${{ matrix.platform-tag }}
          context: ${{ inputs.docker-context }}
          secrets: BLOCKCHAIN_ACTIONS_TOKEN=${{ secrets.BLOCKCHAIN_ACTIONS_TOKEN }}
          file: ./docker/${{ inputs.working-directory }}/${{ inputs.docker-file }}
          push: ${{ inputs.push_image }}
          pull: false
          provenance: false
          sbom: false
          target: ${{ matrix.docker-target }}
          labels: ${{ steps.meta.outputs.labels }}
          tags: |
            ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.platform-tag }}-${{ matrix.docker-target }}
          cache-from: type=s3,blobs_prefix=cache/${{ github.repository }}/,manifests_prefix=cache/${{ github.repository }}/,region=${{ env.RUNS_ON_AWS_REGION }},bucket=${{ env.RUNS_ON_S3_BUCKET_CACHE }}
          cache-to: type=s3,blobs_prefix=cache/${{ github.repository }}/,manifests_prefix=cache/${{ github.repository }}/,region=${{ env.RUNS_ON_AWS_REGION }},bucket=${{ env.RUNS_ON_S3_BUCKET_CACHE }},mode=max

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@db473fddc028af60658334401dc6fa3ffd8669fd  #v2.3.0
        with:
          subject-name: ghcr.io/zama-ai/${{ inputs.image-name }}
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true

      - name: Generate SBOM
        uses: anchore/sbom-action@9f7302141466aa6482940f15371237e9d9f4c34a  # v0.19.0
        with:
          image: ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.platform-tag }}-${{ matrix.docker-target }}
          output-file: sbom-${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.platform-tag }}-${{ matrix.docker-target }}.json

      - name: Add SBOM attestation
        uses: actions/attest-sbom@115c3be05ff3974bcbd596578934b3f9ce39bf68  # v2.2.0
        with:
          subject-name: ghcr.io/zama-ai/${{ inputs.image-name }}
          subject-digest: ${{ steps.push.outputs.digest }}
          sbom-path: 'sbom-${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.platform-tag }}-${{ matrix.docker-target }}.json'
          push-to-registry: true


  create-manifest:
    needs: [determine-tag, build-and-push-docker]
    if: inputs.push_image
    strategy:
      matrix:
        docker-target: ['prod', 'dev']
    runs-on: ${{ inputs.runs-on-amd }}
    outputs:
      image_name: ${{ steps.export-image.outputs.image }}
      image_prod_with_tag: ${{ steps.export-image.outputs.image-prod-with-tag }}
      image_dev_with_tag: ${{ steps.export-image.outputs.image-dev-with-tag }}
      image_prod_latest: ${{ steps.export-image.outputs.image-prod-latest }}
      image_dev_latest: ${{ steps.export-image.outputs.image-dev-latest }}
    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and Push Multiarch Manifest
        run: |
          if [ "${{ matrix.docker-target }}" = "prod" ]; then
            docker manifest create \
              ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-amd64-${{ matrix.docker-target }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-arm64-${{ matrix.docker-target }}

            docker manifest create \
              ghcr.io/zama-ai/${{ inputs.image-name }}:latest \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-amd64-${{ matrix.docker-target }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-arm64-${{ matrix.docker-target }}

            docker manifest push ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}
            docker manifest push ghcr.io/zama-ai/${{ inputs.image-name }}:latest

          else
            docker manifest create \
              ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.docker-target }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-amd64-${{ matrix.docker-target }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-arm64-${{ matrix.docker-target }}

            docker manifest create \
              ghcr.io/zama-ai/${{ inputs.image-name }}:latest-${{ matrix.docker-target }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-amd64-${{ matrix.docker-target }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-arm64-${{ matrix.docker-target }}

            docker manifest push ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.docker-target }}
            docker manifest push ghcr.io/zama-ai/${{ inputs.image-name }}:latest-${{ matrix.docker-target }}
          fi


      - name: Get digest
        id: get_digest
        run: |
          if [ "${{ matrix.docker-target }}" = "prod" ]; then
            export digest_image_tag="$(docker manifest inspect ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }} -v | jq -r '.[0].Descriptor.digest')"
            export docker_image_tag="ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}"
            export digest_image_latest="$(docker manifest inspect ghcr.io/zama-ai/${{ inputs.image-name }}:latest -v | jq -r '.[0].Descriptor.digest')"
            export docker_image_latest="ghcr.io/zama-ai/${{ inputs.image-name }}:latest"
          else
            export digest_image_tag="$(docker manifest inspect ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.docker-target }} -v | jq -r '.[0].Descriptor.digest')"
            export docker_image_tag="ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.docker-target }}"
            export digest_image_latest="$(docker manifest inspect ghcr.io/zama-ai/${{ inputs.image-name }}:latest-${{ matrix.docker-target }} -v | jq -r '.[0].Descriptor.digest')"
            export docker_image_latest="ghcr.io/zama-ai/${{ inputs.image-name }}:latest-${{ matrix.docker-target }}"
          fi
          {
          echo "digest-image-tag=${digest_image_tag}"
          echo "digest-image-latest=${digest_image_latest}"
          echo "docker-image-tag=${docker_image_tag}"
          echo "docker-image-latest=${docker_image_latest}"
          } >> "${GITHUB_OUTPUT}"

      - name: Generate artifact attestation for image tag
        uses: actions/attest-build-provenance@db473fddc028af60658334401dc6fa3ffd8669fd  #v2.3.0
        with:
          subject-name: ghcr.io/zama-ai/${{ inputs.image-name }}
          subject-digest: ${{ steps.get_digest.outputs.digest-image-tag }}
          push-to-registry: true

      - name: Generate SBOM for image tag
        uses: anchore/sbom-action@9f7302141466aa6482940f15371237e9d9f4c34a  # v0.19.0
        with:
          image: ${{ steps.get_digest.outputs.docker-image-tag }}
          output-file: sbom-${{inputs.image-name}}-${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.docker-target }}.json

      - name: Add SBOM attestation for image tag
        uses: actions/attest-sbom@115c3be05ff3974bcbd596578934b3f9ce39bf68  # v2.2.0
        with:
          subject-name: ghcr.io/zama-ai/${{ inputs.image-name }}
          subject-digest: ${{ steps.get_digest.outputs.digest-image-tag }}
          sbom-path: 'sbom-${{ inputs.image-name }}-${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.docker-target }}.json'
          push-to-registry: true

      - name: Generate artifact attestation for image latest
        uses: actions/attest-build-provenance@db473fddc028af60658334401dc6fa3ffd8669fd  #v2.3.0
        with:
          subject-name: ghcr.io/zama-ai/${{ inputs.image-name }}
          subject-digest: ${{ steps.get_digest.outputs.digest-image-latest }}
          push-to-registry: true

      - name: Generate SBOM for image latest
        uses: anchore/sbom-action@9f7302141466aa6482940f15371237e9d9f4c34a  # v0.19.0
        with:
          image: ${{ steps.get_digest.outputs.docker-image-latest }}
          output-file: sbom-${{ inputs.image-name }}-${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.docker-target }}.json

      - name: Add SBOM attestation for image latest
        uses: actions/attest-sbom@115c3be05ff3974bcbd596578934b3f9ce39bf68  # v2.2.0
        with:
          subject-name: ghcr.io/zama-ai/${{ inputs.image-name }}
          subject-digest: ${{ steps.get_digest.outputs.digest-image-latest }}
          sbom-path: 'sbom-${{ inputs.image-name }}-${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.docker-target }}.json'
          push-to-registry: true

      - name: Export image name
        id: export-image
        run: |
          if [ "${{ matrix.docker-target }}" = "prod" ]; then
            {
              echo "image-${{ matrix.docker-target }}-with-tag=ghcr.io/zama-ai/${{inputs.image-name}}:${{ needs.determine-tag.outputs.docker_tag }}"
              echo "image-${{ matrix.docker-target }}-latest=ghcr.io/zama-ai/${{inputs.image-name}}:latest"
            } >> "${GITHUB_OUTPUT}"
          else
            {
              echo "image-${{ matrix.docker-target }}-with-tag=ghcr.io/zama-ai/${{inputs.image-name}}:${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.docker-target }}"
              echo "image-${{ matrix.docker-target }}-latest=ghcr.io/zama-ai/${{inputs.image-name}}:latest-${{ matrix.docker-target }}"
            } >> "${GITHUB_OUTPUT}"
          fi
