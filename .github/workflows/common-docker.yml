name: Docker Build and Push with Multiarch Manifest

on:
  workflow_call:
    secrets:
      BLOCKCHAIN_ACTIONS_TOKEN:
        required: true
      AWS_ACCESS_KEY_S3_USER:
        required: true
      AWS_SECRET_KEY_S3_USER:
        required: true
    inputs:
      ref:
        type: string
        required: false
        default: ''
      working-directory:
        type: string
        required: true
      docker-context:
        type: string
        required: false
        default: '.'
      image-name:
        type: string
        required: true
      push_image:
        type: boolean
        default: true
        required: false
      runs-on-amd:
        type: string
        required: false
        default: 'ubuntu-latest'
      runs-on-arm:
        type: string
        required: false
        default: 'large_ubuntu_16_arm'
      docker-file:
        type: string
        default: 'Dockerfile'
        required: false
      cache-from:
        type: string
        required: false
        default: 'type=gha'
      cache-to:
        type: string
        required: false
        default: 'type=gha,mode=max'
      app-cache-dir:
        type: string
        required: true
    outputs:
      image:
        description: "Image Name with Tag generated by this task"
        value: "${{ jobs.create-manifest.outputs.image_name }}"
      image_tag:
        description: "Docker Tag generated by this task"
        value: "${{ jobs.determine-tag.outputs.docker_tag }}"

permissions: {}

jobs:
  determine-tag:
    permissions:
      contents: 'read'
    runs-on: ubuntu-latest
    outputs:
      docker_tag: ${{ steps.set-tag.outputs.tag }}
    steps:
      - name: Checkout Project
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: 'false'

      - name: Set Docker Tag
        id: set-tag
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "tag=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "tag=nightly-$(git rev-parse --short "$GITHUB_SHA")" >> "$GITHUB_OUTPUT"
          else
            echo "tag=$(git rev-parse --short "$GITHUB_SHA")" >> "$GITHUB_OUTPUT"
          fi

  build-and-push-docker:
    permissions:
      contents: 'read'
      packages: 'write'
    needs: determine-tag
    outputs:
      image: ${{ steps.push.outputs.image }}
      digest: ${{ steps.push.outputs.digest }}
      image-amd64-prod: ${{ steps.export-image-and-digest.outputs.image-amd64-prod }}
      digest-amd64-prod: ${{ steps.export-image-and-digest.outputs.digest-amd64-prod }}
      image-arm64-prod: ${{ steps.export-image-and-digest.outputs.image-arm64-prod }}
      digest-arm64-prod: ${{ steps.export-image-and-digest.outputs.digest-arm64-prod }}
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            runs-on: ${{ inputs.runs-on-amd }}
            platform-tag: amd64
            docker-target: prod
          - platform: linux/arm64
            runs-on: ${{ inputs.runs-on-arm }}
            platform-tag: arm64
            docker-target: prod
          - platform: linux/amd64
            runs-on: ${{ inputs.runs-on-amd }}
            platform-tag: amd64
            docker-target: dev
          - platform: linux/arm64
            runs-on: ${{ inputs.runs-on-arm }}
            platform-tag: arm64
            docker-target: dev
    runs-on: ${{ matrix.runs-on }}
    steps:
      - name: Checkout Project
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          submodules: 'true'
          token: ${{ secrets.BLOCKCHAIN_ACTIONS_TOKEN }}
          persist-credentials: 'false'

      - name: Get Rust version
        run: |
          version="$(cat ${{ github.workspace }}/toolchain.txt)"
          echo "RUST_IMAGE_VERSION=$version" >> "$GITHUB_ENV"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb # v3.3.0
        with:
          platforms: ${{ matrix.platform }}


      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4.0.2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_S3_USER }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY_S3_USER }}
          aws-region: eu-west-3

      ############################################################################
      # Setup cache for dockerfile and inject in docker
      #
      - name: Setup Cache
        uses: runs-on/cache@197b09d6da1bf42f673fee18769c794b789a0c7d # v4
        id: cache
        env:
          RUNS_ON_S3_BUCKET_CACHE: gh-actions-cache-eu-west-3
          RUNS_ON_AWS_REGION: eu-west-3
        with:
          path: |
            var-cache-apk
            var-lib-apk
            usr-local-cargo-registry
            usr-local-cargo-git
            usr-local-cargo-bin
            usr-local-cargo-registry-index
            usr-local-cargo-registry-cache
            usr-local-cargo-git-db
            app-${{ inputs.app-cache-dir }}-target
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
            /sccache
          key: |
            ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: inject cache into docker
        uses: reproducible-containers/buildkit-cache-dance@5b6db76d1da5c8b307d5d2e0706d266521b710de # v3.1.2
        with:
          cache-map: |
            {
              "var-cache-apk": "/var/cache/apk",
              "var-lib-apk": "/var/lib/apk",
              "usr-local-cargo-registry": "/usr/local/cargo/registry",
              "usr-local-cargo-git": "/usr/local/cargo/git",
              "usr-local-cargo-bin": "/usr/local/cargo/bin",
              "usr-local-cargo-registry-index": "/usr/local/cargo/registry/index",
              "usr-local-cargo-registry-cache": "/usr/local/cargo/registry/cache",
              "usr-local-cargo-git-db": "/usr/local/cargo/git/db",
              "app-${{ inputs.app-cache-dir }}-target": "/app/${{ inputs.app-cache-dir }}/target",
              "sccache": "/sccache"
            }
          skip-extraction: ${{ steps.cache.outputs.cache-hit }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@902fa8ec7d6ecbf8d84d538b9b233a880e428804  # v5.7.0
        with:
          labels: |
            org.opencontainers.image.title=${{ inputs.image-name }}
            org.opencontainers.image.description=${{ inputs.image-name }} docker image in version ${{ needs.determine-tag.outputs.docker_tag }}
            org.opencontainers.image.vendor=zama.ai
            org.opencontainers.image.version=${{ needs.determine-tag.outputs.docker_tag }}
            org.opencontainers.image.rust-version=${{ env.RUST_IMAGE_VERSION }}

      - name: Docker Build and Push with Platform Tag
        id: push
        uses: docker/build-push-action@5cd11c3a4ced054e52742c5fd54dca954e0edd85 # v6.7.0
        env:
          RUNS_ON_S3_BUCKET_CACHE: gh-actions-cache-eu-west-3
          RUNS_ON_AWS_REGION: eu-west-3
        with:
          build-args: |
            RUST_IMAGE_VERSION=${{ env.RUST_IMAGE_VERSION }}
            TARGETARCH=${{ matrix.platform-tag }}
          context: ${{ inputs.docker-context }}
          secrets: BLOCKCHAIN_ACTIONS_TOKEN=${{ secrets.BLOCKCHAIN_ACTIONS_TOKEN }}
          file: ${{ inputs.docker-file }}
          platforms: ${{ matrix.platform }}
          push: ${{ inputs.push_image }}
          pull: false
          provenance: false
          sbom: false
          target: ${{ matrix.docker-target }}
          labels: ${{ steps.meta.outputs.labels }}
          tags: |
            ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.platform-tag }}-${{ matrix.docker-target }}
          cache-from: type=s3,blobs_prefix=cache/${{ github.repository }}/,manifests_prefix=cache/${{ github.repository }}/,region=${{ env.RUNS_ON_AWS_REGION }},bucket=${{ env.RUNS_ON_S3_BUCKET_CACHE }}
          cache-to: type=s3,blobs_prefix=cache/${{ github.repository }}/,manifests_prefix=cache/${{ github.repository }}/,region=${{ env.RUNS_ON_AWS_REGION }},bucket=${{ env.RUNS_ON_S3_BUCKET_CACHE }},mode=max

      - name: Export image and digest
        id: export-image-and-digest
        if: matrix.docker-target == 'prod'
        run: |
          if ${{ matrix.platform-tag == 'amd64' }}
          then
            echo "image-amd64-prod=${{ steps.push.outputs.image }}" >> $GITHUB_OUTPUT
            echo "digest-amd64-prod=${{ steps.push.outputs.digest }}" >> $GITHUB_OUTPUT
          fi
          if ${{ matrix.platform-tag == 'arm64' }}
          then
            echo "image-arm64-prod=${{ steps.push.outputs.image }}" >> $GITHUB_OUTPUT
            echo "digest-arm64-prod=${{ steps.push.outputs.digest }}" >> $GITHUB_OUTPUT
          fi

  provenance-amd64-prod:
    permissions:
      actions: 'read'
      attestations: 'write'
      packages: 'write'
      id-token: write
    needs: [build-and-push-docker]
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main'
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
    with:
      image: ghcr.io/zama-ai/${{ inputs.image-name }}
      digest: ${{ needs.build-and-push-docker.outputs.digest-amd64-prod }}
      registry-username: ${{ github.actor }}
      private-repository: true
    secrets:
      registry-password: ${{ secrets.GITHUB_TOKEN }}

  provenance-arm64-prod:
    permissions:
      actions: 'read'
      attestations: 'write'
      packages: 'write'
      id-token: write
    needs: [build-and-push-docker]
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main'
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
    with:
      image: ghcr.io/zama-ai/${{ inputs.image-name }}
      digest: ${{ needs.build-and-push-docker.outputs.digest-arm64-prod }}
      registry-username: ${{ github.actor }}
      private-repository: true
    secrets:
      registry-password: ${{ secrets.GITHUB_TOKEN }}


  create-manifest:
    permissions:
      contents: 'read'
      packages: 'write'
    needs: [determine-tag, build-and-push-docker]
    outputs:
      image_name: ${{ steps.export-image.outputs.image-prod-with-tag }}
    if: inputs.push_image
    strategy:
      matrix:
        docker-target: ['prod', 'dev']
    runs-on: ${{ inputs.runs-on-amd }}
    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and Push Multiarch Manifest
        run: |
          if [ "${{ matrix.docker-target }}" = "prod" ]; then
            docker manifest create \
              ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-amd64-${{ matrix.docker-target }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-arm64-${{ matrix.docker-target }}

            docker manifest create \
              ghcr.io/zama-ai/${{ inputs.image-name }}:latest \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-amd64-${{ matrix.docker-target }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-arm64-${{ matrix.docker-target }}

            docker manifest push ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}
            docker manifest push ghcr.io/zama-ai/${{ inputs.image-name }}:latest

          else
            docker manifest create \
              ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.docker-target }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-amd64-${{ matrix.docker-target }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-arm64-${{ matrix.docker-target }}

            docker manifest create \
              ghcr.io/zama-ai/${{ inputs.image-name }}:latest-${{ matrix.docker-target }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-amd64-${{ matrix.docker-target }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-arm64-${{ matrix.docker-target }}

            docker manifest push ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.docker-target }}
            docker manifest push ghcr.io/zama-ai/${{ inputs.image-name }}:latest-${{ matrix.docker-target }}
          fi

      - name: Export image name
        id: export-image
        run: |
          if [ "${{ matrix.docker-target }}" = "prod" ]; then
            {
              echo "image-${{ matrix.docker-target }}-with-tag=ghcr.io/zama-ai/${{inputs.image-name}}:${{ needs.determine-tag.outputs.docker_tag }}"
              echo "image-${{ matrix.docker-target }}-latest=ghcr.io/zama-ai/${{inputs.image-name}}:latest"
            } >> "${GITHUB_OUTPUT}"
          else
            {
              echo "image-${{ matrix.docker-target }}-with-tag=ghcr.io/zama-ai/${{inputs.image-name}}:${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.docker-target }}"
              echo "image-${{ matrix.docker-target }}-latest=ghcr.io/zama-ai/${{inputs.image-name}}:latest-${{ matrix.docker-target }}"
            } >> "${GITHUB_OUTPUT}"
          fi

      - name: Add image name to job summary
        run: |
            echo "## Docker Images Published ✅" >> "$GITHUB_STEP_SUMMARY"
            if [ "${{ matrix.docker-target }}" = "prod" ]; then
              echo "**Image Name (prod):** \`${{ steps.export-image.outputs.image-prod-with-tag }}\`" >> "$GITHUB_STEP_SUMMARY"
            fi
            if [ "${{ matrix.docker-target }}" = "dev" ]; then
              echo "**Image Name (dev):** \`${{ steps.export-image.outputs.image-dev-with-tag }}\`" >> "$GITHUB_STEP_SUMMARY"
            fi