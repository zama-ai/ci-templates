name: Docker Build and Push with Multiarch Manifest

on:
  workflow_call:
    secrets:
      BLOCKCHAIN_ACTIONS_TOKEN:
        required: true
      AWS_ACCESS_KEY_S3_USER:
        required: true
      AWS_SECRET_KEY_S3_USER:
        required: true
      CGR_USERNAME:
        required: false
      CGR_PASSWORD:
        required: false
    inputs:
      use-cgr-secrets:
        type: boolean
        required: false
        default: false
      ref:
        type: string
        required: false
        default: ''
      working-directory:
        type: string
        required: true
      docker-context:
        type: string
        required: false
        default: '.'
      image-name:
        type: string
        required: true
      image-tag:
        type: string
        required: false
        default: ''
      push_image:
        type: boolean
        default: true
        required: false
      runs-on-amd:
        type: string
        required: false
        default: 'ubuntu-latest'
      runs-on-arm:
        type: string
        required: false
        default: 'large_ubuntu_16_arm'
      docker-file:
        type: string
        default: 'Dockerfile'
        required: false
      cache-from:
        type: string
        required: false
        default: 'type=gha'
      cache-to:
        type: string
        required: false
        default: 'type=gha,mode=max'
      app-cache-dir:
        type: string
        required: true
    outputs:
      image:
        description: 'Image Name with Tag generated by this task'
        value: '${{ jobs.create-manifest.outputs.image_name }}'
      image_tag:
        description: 'Docker Tag generated by this task'
        value: '${{ jobs.determine-tag.outputs.docker_tag }}'

permissions: {}

jobs:
  determine-tag:
    permissions:
      contents: 'read'
    runs-on: ubuntu-latest
    outputs:
      docker_tag: ${{ steps.set-tag.outputs.tag }}
    steps:
      - name: Checkout Project
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: 'false'

      - name: Set Docker Tag
        id: set-tag
        env:
          COMMIT_HASH: ${{ github.event.pull_request.head.sha || github.sha }}
        run: |
          if [[ -n "${{ inputs.image-tag }}" ]]; then
            echo "tag=${{ inputs.image-tag }}" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.event_name }}" == "release" ]]; then
            REF="${{ github.ref_name }}"
            VERSION=$(echo "$REF" | rev | cut -d'@' -f1 | rev)
            echo "VERSION: $VERSION"
            echo "tag=$VERSION" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "tag=nightly-$(git rev-parse --short "$COMMIT_HASH")" >> "$GITHUB_OUTPUT"
          else
            echo "tag=$(git rev-parse --short "$COMMIT_HASH")" >> "$GITHUB_OUTPUT"
          fi

  build-and-push-docker:
    permissions:
      contents: 'read'
      packages: 'write'
    needs: determine-tag
    outputs:
      image: ${{ steps.push.outputs.image }}
      digest: ${{ steps.push.outputs.digest }}
      image-amd64-prod: ${{ steps.export-image-and-digest.outputs.image-amd64-prod }}
      digest-amd64-prod: ${{ steps.export-image-and-digest.outputs.digest-amd64-prod }}
      image-arm64-prod: ${{ steps.export-image-and-digest.outputs.image-arm64-prod }}
      digest-arm64-prod: ${{ steps.export-image-and-digest.outputs.digest-arm64-prod }}
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            runs-on: ${{ inputs.runs-on-amd }}
            platform-tag: amd64
            docker-target: prod
          - platform: linux/arm64
            runs-on: ${{ inputs.runs-on-arm }}
            platform-tag: arm64
            docker-target: prod
          - platform: linux/amd64
            runs-on: ${{ inputs.runs-on-amd }}
            platform-tag: amd64
            docker-target: dev
          - platform: linux/arm64
            runs-on: ${{ inputs.runs-on-arm }}
            platform-tag: arm64
            docker-target: dev
    runs-on: ${{ matrix.runs-on }}
    steps:
      - name: Checkout Project
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          submodules: 'true'
          token: ${{ secrets.BLOCKCHAIN_ACTIONS_TOKEN }}
          persist-credentials: 'false'

      - name: Get Rust version
        run: |
          version="$(cat ${{ github.workspace }}/toolchain.txt)"
          echo "RUST_IMAGE_VERSION=$version" >> "$GITHUB_ENV"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb # v3.3.0
        with:
          driver-opts: image=moby/buildkit:v0.25.1 # https://github.com/moby/buildkit/issues/6357 could be removed once buildkit is fixed
          platforms: ${{ matrix.platform }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4.0.2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_S3_USER }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY_S3_USER }}
          aws-region: eu-west-3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Chainguard Container Registry
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        if: ${{ inputs.use-cgr-secrets }}
        with:
          registry: cgr.dev
          username: ${{ secrets.CGR_USERNAME }}
          password: ${{ secrets.CGR_PASSWORD }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@902fa8ec7d6ecbf8d84d538b9b233a880e428804 # v5.7.0
        with:
          labels: |
            org.opencontainers.image.title=${{ inputs.image-name }}
            org.opencontainers.image.description=${{ inputs.image-name }} docker image in version ${{ needs.determine-tag.outputs.docker_tag }}
            org.opencontainers.image.vendor=zama.ai
            org.opencontainers.image.version=${{ needs.determine-tag.outputs.docker_tag }}
            org.opencontainers.image.rust-version=${{ env.RUST_IMAGE_VERSION }}

      - name: Docker Build and Push with Platform Tag
        id: push
        uses: docker/build-push-action@5cd11c3a4ced054e52742c5fd54dca954e0edd85 # v6.7.0
        env:
          RUNS_ON_S3_BUCKET_CACHE: gh-actions-cache-eu-west-3
          RUNS_ON_AWS_REGION: eu-west-3
        with:
          build-args: |
            RUST_IMAGE_VERSION=${{ env.RUST_IMAGE_VERSION }}
            TARGETARCH=${{ matrix.platform-tag }}
            APP_CACHE_DIR=${{ inputs.app-cache-dir }}
          context: ${{ inputs.docker-context }}
          secrets: BLOCKCHAIN_ACTIONS_TOKEN=${{ secrets.BLOCKCHAIN_ACTIONS_TOKEN }}
          file: ${{ inputs.docker-file }}
          platforms: ${{ matrix.platform }}
          push: ${{ inputs.push_image }}
          pull: false
          provenance: false
          sbom: false
          target: ${{ matrix.docker-target }}
          labels: ${{ steps.meta.outputs.labels }}
          tags: |
            ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.platform-tag }}-${{ matrix.docker-target }}
          cache-from: type=s3,blobs_prefix=cache/${{ github.repository }}-${{ inputs.app-cache-dir }}-${{ matrix.platform-tag }}/,manifests_prefix=cache/${{ github.repository }}-${{ inputs.app-cache-dir }}-${{ matrix.platform-tag }}/,region=${{ env.RUNS_ON_AWS_REGION }},bucket=${{ env.RUNS_ON_S3_BUCKET_CACHE }}
          cache-to: type=s3,blobs_prefix=cache/${{ github.repository }}-${{ inputs.app-cache-dir }}-${{ matrix.platform-tag }}/,manifests_prefix=cache/${{ github.repository }}-${{ inputs.app-cache-dir }}-${{ matrix.platform-tag }}/,region=${{ env.RUNS_ON_AWS_REGION }},bucket=${{ env.RUNS_ON_S3_BUCKET_CACHE }},mode=max

      - name: Export image and digest
        id: export-image-and-digest
        if: matrix.docker-target == 'prod'
        run: |
          if ${{ matrix.platform-tag == 'amd64' }}
          then
            echo "image-amd64-prod=${{ steps.push.outputs.image }}" >> $GITHUB_OUTPUT
            echo "digest-amd64-prod=${{ steps.push.outputs.digest }}" >> $GITHUB_OUTPUT
          fi
          if ${{ matrix.platform-tag == 'arm64' }}
          then
            echo "image-arm64-prod=${{ steps.push.outputs.image }}" >> $GITHUB_OUTPUT
            echo "digest-arm64-prod=${{ steps.push.outputs.digest }}" >> $GITHUB_OUTPUT
          fi

  create-manifest:
    permissions:
      contents: 'read'
      packages: 'write'
      id-token: 'write'
    needs: [determine-tag, build-and-push-docker]
    outputs:
      image_name: ${{ steps.export-image.outputs.image-prod-with-tag }}
    if: inputs.push_image
    strategy:
      matrix:
        docker-target: ['prod', 'dev']
    runs-on: ${{ inputs.runs-on-amd }}
    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and Push Multiarch Manifest
        run: |
          if [ "${{ matrix.docker-target }}" = "prod" ]; then
            docker manifest create \
              ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-amd64-${{ matrix.docker-target }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-arm64-${{ matrix.docker-target }}

            docker manifest create \
              ghcr.io/zama-ai/${{ inputs.image-name }}:latest \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-amd64-${{ matrix.docker-target }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-arm64-${{ matrix.docker-target }}

            docker manifest push ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}
            if [ "${{ github.event_name }}" = "release" ]; then
              docker manifest push ghcr.io/zama-ai/${{ inputs.image-name }}:latest
            fi

          else
            docker manifest create \
              ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.docker-target }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-amd64-${{ matrix.docker-target }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-arm64-${{ matrix.docker-target }}

            docker manifest create \
              ghcr.io/zama-ai/${{ inputs.image-name }}:latest-${{ matrix.docker-target }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-amd64-${{ matrix.docker-target }} \
              --amend ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-arm64-${{ matrix.docker-target }}

            docker manifest push ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.docker-target }}
            if [ "${{ github.event_name }}" = "release" ]; then
              docker manifest push ghcr.io/zama-ai/${{ inputs.image-name }}:latest-${{ matrix.docker-target }}
            fi
          fi

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
        if: github.event_name == 'release'

      - name: Sign image with Cosign
        if: github.event_name == 'release'
        run: |
          if [ "${{ matrix.docker-target }}" = "prod" ]; then
            docker pull ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }}
            IMAGE_WITH_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ghcr.io/zama-ai/${{ inputs.image-name }}:${{ needs.determine-tag.outputs.docker_tag }})
            cosign sign --yes --recursive=true $IMAGE_WITH_DIGEST
          fi

      - name: Export image name
        id: export-image
        run: |
          if [ "${{ matrix.docker-target }}" = "prod" ]; then
            {
              echo "image-${{ matrix.docker-target }}-with-tag=ghcr.io/zama-ai/${{inputs.image-name}}:${{ needs.determine-tag.outputs.docker_tag }}"
            } >> "${GITHUB_OUTPUT}"
          if [ "${{ github.event_name }}" = "release" ]; then
            {
              echo "image-${{ matrix.docker-target }}-latest=ghcr.io/zama-ai/${{inputs.image-name}}:latest"
            } >> "${GITHUB_OUTPUT}"
          fi
          else
            {
              echo "image-${{ matrix.docker-target }}-with-tag=ghcr.io/zama-ai/${{inputs.image-name}}:${{ needs.determine-tag.outputs.docker_tag }}-${{ matrix.docker-target }}"
            } >> "${GITHUB_OUTPUT}"
            if [ "${{ github.event_name }}" = "release" ]; then
              {
                echo "image-${{ matrix.docker-target }}-latest=ghcr.io/zama-ai/${{inputs.image-name}}:latest-${{ matrix.docker-target }}"
              } >> "${GITHUB_OUTPUT}"
            fi
          fi

      - name: Add image name to job summary
        run: |
          echo "## Docker Images Published âœ…" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ matrix.docker-target }}" = "prod" ]; then
            echo "**Image Name (prod):** \`${{ steps.export-image.outputs.image-prod-with-tag }}\`" >> "$GITHUB_STEP_SUMMARY"
          fi
          if [ "${{ matrix.docker-target }}" = "dev" ]; then
            echo "**Image Name (dev):** \`${{ steps.export-image.outputs.image-dev-with-tag }}\`" >> "$GITHUB_STEP_SUMMARY"
          fi
